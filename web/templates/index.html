<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            font-size: 20px;
        }

        .search-box {
            display: flex;
            gap: 10px;
        }

        .search-box input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 300px;
        }

        .search-box button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .search-box button:hover {
            background: #5568d3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f8f8;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f8f8;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button:hover {
            background: #f0f0f0;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
        }

        .missing-badge {
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 5px;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 10px;
            width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 24px;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .form-actions button {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-save {
            background: #667eea;
            color: white;
        }

        .btn-save:hover {
            background: #5568d3;
        }

        .filter-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸµ Fish Music ç®¡ç†åå°</h1>
            <p>ä¸ªäººäº‘éŸ³ä¹æœºå™¨äººç®¡ç†ç³»ç»Ÿ</p>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>æ€»æ­Œæ›²æ•°</h3>
                <div class="value" id="totalSongs">-</div>
            </div>
            <div class="stat-card">
                <h3>æ­Œæ‰‹æ•°é‡</h3>
                <div class="value" id="totalArtists">-</div>
            </div>
            <div class="stat-card">
                <h3>ç¼ºå¤±æ­Œæ›²</h3>
                <div class="value" id="missingSongs">-</div>
            </div>
            <div class="stat-card">
                <h3>ä»Šæ—¥æ–°å¢</h3>
                <div class="value" id="todayAdded">-</div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <h2>ğŸ“‹ æ­Œæ›²åˆ—è¡¨</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="æœç´¢æ­Œæ›²åæˆ–æ­Œæ‰‹...">
                    <select id="genreFilter" class="filter-select" onchange="searchSongs()">
                        <option value="">æ‰€æœ‰ç±»å‹</option>
                        <option value="æµè¡Œ">æµè¡Œ</option>
                        <option value="æ‘‡æ»š">æ‘‡æ»š</option>
                        <option value="è¯´å”±">è¯´å”±</option>
                        <option value="æ°‘è°£">æ°‘è°£</option>
                        <option value="ç”µå­">ç”µå­</option>
                        <option value="å¤å…¸">å¤å…¸</option>
                        <option value="çˆµå£«">çˆµå£«</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                    <select id="languageFilter" class="filter-select" onchange="searchSongs()">
                        <option value="">æ‰€æœ‰è¯­è¨€</option>
                        <option value="åè¯­">åè¯­</option>
                        <option value="è‹±è¯­">è‹±è¯­</option>
                        <option value="æ—¥è¯­">æ—¥è¯­</option>
                        <option value="éŸ©è¯­">éŸ©è¯­</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                    <button onclick="searchSongs()">æœç´¢</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>æ ‡é¢˜</th>
                        <th>æ­Œæ‰‹</th>
                        <th>ç±»å‹</th>
                        <th>è¯­è¨€</th>
                        <th>å›½å®¶</th>
                        <th>ä¸“è¾‘</th>
                        <th>æ—¶é•¿</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="songsTable">
                    <tr>
                        <td colspan="10" style="text-align: center;">åŠ è½½ä¸­...</td>
                    </tr>
                </tbody>
            </table>
            <div class="pagination" id="pagination"></div>
        </div>

        <div class="section">
            <div class="section-header">
                <h2>âŒ ç¼ºå¤±æ­Œæ›²è¡¥æ¡£</h2>
                <button class="btn btn-primary" onclick="loadMissingSongs()">åˆ·æ–°</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>æ ‡é¢˜</th>
                        <th>æ­Œæ‰‹</th>
                        <th>æºé“¾æ¥</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="missingTable">
                    <tr>
                        <td colspan="5" style="text-align: center;">æ— ç¼ºå¤±æ­Œæ›²</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ç¼–è¾‘æ­Œæ›²æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç¼–è¾‘æ­Œæ›²ä¿¡æ¯</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="editForm" onsubmit="saveSong(event)">
                <input type="hidden" id="editSongId">
                <div class="form-group">
                    <label for="editTitle">æ­Œæ›²æ ‡é¢˜</label>
                    <input type="text" id="editTitle" required>
                </div>
                <div class="form-group">
                    <label for="editArtist">æ­Œæ‰‹</label>
                    <input type="text" id="editArtist" required>
                </div>
                <div class="form-group">
                    <label for="editAlbum">ä¸“è¾‘</label>
                    <input type="text" id="editAlbum">
                </div>
                <div class="form-group">
                    <label for="editGenre">æ­Œæ›²ç±»å‹</label>
                    <select id="editGenre" class="filter-select" style="width: 100%">
                        <option value="">æœªåˆ†ç±»</option>
                        <option value="æµè¡Œ">æµè¡Œ</option>
                        <option value="æ‘‡æ»š">æ‘‡æ»š</option>
                        <option value="è¯´å”±">è¯´å”±</option>
                        <option value="æ°‘è°£">æ°‘è°£</option>
                        <option value="ç”µå­">ç”µå­</option>
                        <option value="å¤å…¸">å¤å…¸</option>
                        <option value="çˆµå£«">çˆµå£«</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editLanguage">æ­Œæ›²è¯­è¨€</label>
                    <select id="editLanguage" class="filter-select" style="width: 100%">
                        <option value="">æœªçŸ¥</option>
                        <option value="åè¯­">åè¯­</option>
                        <option value="è‹±è¯­">è‹±è¯­</option>
                        <option value="æ—¥è¯­">æ—¥è¯­</option>
                        <option value="éŸ©è¯­">éŸ©è¯­</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editCountry">æ­Œæ‰‹å›½ç±</label>
                    <select id="editCountry" class="filter-select" style="width: 100%">
                        <option value="">æœªçŸ¥</option>
                        <option value="CN">ğŸ‡¨ğŸ‡³ ä¸­å›½</option>
                        <option value="JP">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option>
                        <option value="KR">ğŸ‡°ğŸ‡· éŸ©å›½</option>
                        <option value="US">ğŸ‡ºğŸ‡¸ ç¾å›½</option>
                        <option value="UK">ğŸ‡¬ğŸ‡§ è‹±å›½</option>
                        <option value="DE">ğŸ‡©ğŸ‡ª å¾·å›½</option>
                        <option value="FR">ğŸ‡«ğŸ‡· æ³•å›½</option>
                        <option value="IT">ğŸ‡®ğŸ‡¹ æ„å¤§åˆ©</option>
                        <option value="ES">ğŸ‡ªğŸ‡¸ è¥¿ç­ç‰™</option>
                        <option value="RU">ğŸ‡·ğŸ‡º ä¿„ç½—æ–¯</option>
                        <option value="CA">ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§</option>
                        <option value="AU">ğŸ‡¦ğŸ‡º æ¾³å¤§åˆ©äºš</option>
                        <option value="BR">ğŸ‡§ğŸ‡· å·´è¥¿</option>
                        <option value="MX">ğŸ‡²ğŸ‡½ å¢¨è¥¿å“¥</option>
                        <option value="IN">ğŸ‡®ğŸ‡³ å°åº¦</option>
                        <option value="TW">ğŸ‡¹ğŸ‡¼ å°æ¹¾</option>
                        <option value="HK">ğŸ‡­ğŸ‡° é¦™æ¸¯</option>
                        <option value="SG">ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡</option>
                        <option value="MY">ğŸ‡²ğŸ‡¾ é©¬æ¥è¥¿äºš</option>
                        <option value="TH">ğŸ‡¹ğŸ‡­ æ³°å›½</option>
                        <option value="VN">ğŸ‡»ğŸ‡³ è¶Šå—</option>
                        <option value="ID">ğŸ‡®ğŸ‡© å°å°¼</option>
                        <option value="PH">ğŸ‡µğŸ‡­ è²å¾‹å®¾</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn-save">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentPage = 1;
        let currentQuery = '';

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            const response = await fetch(`${API_BASE}/stats`);
            const data = await response.json();

            document.getElementById('totalSongs').textContent = data.total_songs || 0;
            document.getElementById('totalArtists').textContent = data.total_artists || 0;
            document.getElementById('missingSongs').textContent = data.missing_songs || 0;
            document.getElementById('todayAdded').textContent = data.today_added || 0;
        }

        // åŠ è½½æ­Œæ›²åˆ—è¡¨
        async function loadSongs(page = 1, query = '') {
            const genre = document.getElementById('genreFilter').value;
            const language = document.getElementById('languageFilter').value;

            let url = `${API_BASE}/songs?page=${page}&limit=20&q=${encodeURIComponent(query)}`;
            if (genre) url += `&genre=${encodeURIComponent(genre)}`;
            if (language) url += `&language=${encodeURIComponent(language)}`;

            const response = await fetch(url);
            const data = await response.json();

            const tbody = document.getElementById('songsTable');
            if (data.songs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">æš‚æ— æ­Œæ›²</td></tr>';
                return;
            }

            tbody.innerHTML = data.songs.map(song => `
                <tr>
                    <td>${song.id}</td>
                    <td>${song.title}</td>
                    <td>${song.artist}</td>
                    <td>${song.genre || '-'}</td>
                    <td>${song.language || '-'}</td>
                    <td>${getCountryEmoji(song.country_code)}</td>
                    <td>${song.album || '-'}</td>
                    <td>${formatDuration(song.duration)}</td>
                    <td>
                        <span class="badge ${song.is_missing ? 'badge-danger' : 'badge-success'}">
                            ${song.is_missing ? 'ç¼ºå¤±' : 'æ­£å¸¸'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary" onclick="editSong(${song.id})">ç¼–è¾‘</button>
                        ${song.is_missing ? `<button class="btn btn-warning" onclick="reprocessSong(${song.id})">è¡¥æ¡£</button>` : ''}
                        <button class="btn btn-danger" onclick="deleteSong(${song.id})">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');

            renderPagination(data.total, data.page, data.limit);
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${min}:${sec.toString().padStart(2, '0')}`;
        }

        // è·å–å›½å®¶ Emoji
        function getCountryEmoji(countryCode) {
            const emojiMap = {
                'CN': 'ğŸ‡¨ğŸ‡³',
                'JP': 'ğŸ‡¯ğŸ‡µ',
                'US': 'ğŸ‡ºğŸ‡¸',
                'UK': 'ğŸ‡¬ğŸ‡§',
                'KR': 'ğŸ‡°ğŸ‡·',
                'DE': 'ğŸ‡©ğŸ‡ª',
                'FR': 'ğŸ‡«ğŸ‡·',
                'IT': 'ğŸ‡®ğŸ‡¹',
                'ES': 'ğŸ‡ªğŸ‡¸',
                'RU': 'ğŸ‡·ğŸ‡º',
                'CA': 'ğŸ‡¨ğŸ‡¦',
                'AU': 'ğŸ‡¦ğŸ‡º',
                'BR': 'ğŸ‡§ğŸ‡·',
                'MX': 'ğŸ‡²ğŸ‡½',
                'IN': 'ğŸ‡®ğŸ‡³',
                'TW': 'ğŸ‡¹ğŸ‡¼',
                'HK': 'ğŸ‡­ğŸ‡°',
                'SG': 'ğŸ‡¸ğŸ‡¬',
                'MY': 'ğŸ‡²ğŸ‡¾',
                'TH': 'ğŸ‡¹ğŸ‡­',
                'VN': 'ğŸ‡»ğŸ‡³',
                'ID': 'ğŸ‡®ğŸ‡©',
                'PH': 'ğŸ‡µğŸ‡­',
            };
            return emojiMap[countryCode] || 'ğŸŒ';
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination(total, page, limit) {
            const totalPages = Math.ceil(total / limit);
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="${i === page ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            pagination.innerHTML = html;
        }

        // æœç´¢æ­Œæ›²
        function searchSongs() {
            currentQuery = document.getElementById('searchInput').value;
            currentPage = 1;
            loadSongs(currentPage, currentQuery);
        }

        // è·³è½¬é¡µé¢
        function goToPage(page) {
            currentPage = page;
            loadSongs(currentPage, currentQuery);
        }

        // åŠ è½½ç¼ºå¤±æ­Œæ›²
        async function loadMissingSongs() {
            const response = await fetch(`${API_BASE}/songs/missing`);
            const data = await response.json();

            const tbody = document.getElementById('missingTable');
            if (data.songs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">æ— ç¼ºå¤±æ­Œæ›²</td></tr>';
                return;
            }

            tbody.innerHTML = data.songs.map(song => `
                <tr>
                    <td>${song.id}</td>
                    <td>${song.title}</td>
                    <td>${song.artist}</td>
                    <td><a href="${song.source_url}" target="_blank">é“¾æ¥</a></td>
                    <td>
                        <button class="btn btn-warning" onclick="reprocessSong(${song.id})">ä¸€é”®é‡æŠ“</button>
                    </td>
                </tr>
            `).join('');
        }

        // é‡æ–°å¤„ç†æ­Œæ›²
        async function reprocessSong(id) {
            if (!confirm('ç¡®å®šè¦é‡æ–°ä¸‹è½½å¹¶ä¸Šä¼ è¿™é¦–æ­Œå—ï¼Ÿ')) return;

            try {
                await fetch(`${API_BASE}/songs/${id}/reprocess`, { method: 'POST' });
                alert('è¡¥æ¡£ä»»åŠ¡å·²æäº¤');
                loadSongs(currentPage, currentQuery);
                loadMissingSongs();
                loadStats();
            } catch (error) {
                alert('æ“ä½œå¤±è´¥');
            }
        }

        // ç¼–è¾‘æ­Œæ›²
        async function editSong(id) {
            // è·å–æ­Œæ›²ä¿¡æ¯
            const response = await fetch(`${API_BASE}/songs/${id}`);
            const song = await response.json();

            // å¡«å……è¡¨å•
            document.getElementById('editSongId').value = song.id;
            document.getElementById('editTitle').value = song.title;
            document.getElementById('editArtist').value = song.artist;
            document.getElementById('editAlbum').value = song.album || '';
            document.getElementById('editGenre').value = song.genre || '';
            document.getElementById('editLanguage').value = song.language || '';
            document.getElementById('editCountry').value = song.country_code || '';

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('editModal').style.display = 'block';
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editForm').reset();
        }

        // ä¿å­˜æ­Œæ›²ä¿¡æ¯
        async function saveSong(event) {
            event.preventDefault();

            const id = document.getElementById('editSongId').value;
            const title = document.getElementById('editTitle').value;
            const artist = document.getElementById('editArtist').value;
            const album = document.getElementById('editAlbum').value;
            const genre = document.getElementById('editGenre').value;
            const language = document.getElementById('editLanguage').value;
            const country_code = document.getElementById('editCountry').value;

            try {
                await fetch(`${API_BASE}/songs/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, artist, album, genre, language, country_code })
                });

                closeEditModal();
                alert('æ›´æ–°æˆåŠŸ');
                loadSongs(currentPage, currentQuery);
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥');
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeEditModal();
            }
        }

        // åˆ é™¤æ­Œæ›²
        async function deleteSong(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™é¦–æ­Œå—ï¼Ÿ')) return;

            await fetch(`${API_BASE}/songs/${id}`, { method: 'DELETE' });
            alert('åˆ é™¤æˆåŠŸ');
            loadSongs(currentPage, currentQuery);
            loadStats();
        }

        // åˆå§‹åŒ–
        loadStats();
        loadSongs();
        loadMissingSongs();

        // æœç´¢æ¡†å›è½¦äº‹ä»¶
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchSongs();
        });
    </script>
</body>
</html>
