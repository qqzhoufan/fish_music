#!/usr/bin/env python3
"""
YouTube Cookies å¯¼å‡ºå·¥å…·
ä½¿ç”¨ browser_cookie3 åº“ä»æµè§ˆå™¨è¯»å– YouTube cookies å¹¶å¯¼å‡ºä¸º yt-dlp å¯ç”¨çš„æ ¼å¼
"""

import sys
import os

try:
    import browser_cookie3
except ImportError:
    print("âŒ ç¼ºå°‘ä¾èµ–åº“")
    print("\nè¯·å…ˆå®‰è£… browser_cookie3ï¼š")
    print("  pip install browser_cookie3")
    sys.exit(1)


def get_youtube_cookies(browser_name='chrome'):
    """
    ä»æµè§ˆå™¨è·å– YouTube cookies

    æ”¯æŒçš„æµè§ˆå™¨:
    - chrome (Chrome, Edge, Brave, Opera)
    - firefox
    - safari (ä»… macOS)
    """

    browser_name = browser_name.lower()

    # è·å– cookies
    try:
        if browser_name == 'chrome':
            cookies = browser_cookie3.chrome(domain_name='.youtube.com')
            print(f"âœ… å·²ä» Chrome è¯»å– cookies")
        elif browser_name == 'firefox':
            cookies = browser_cookie3.firefox(domain_name='.youtube.com')
            print(f"âœ… å·²ä» Firefox è¯»å– cookies")
        elif browser_name == 'safari':
            cookies = browser_cookie3.safari(domain_name='.youtube.com')
            print(f"âœ… å·²ä» Safari è¯»å– cookies")
        elif browser_name == 'edge':
            cookies = browser_cookie3.edge(domain_name='.youtube.com')
            print(f"âœ… å·²ä» Edge è¯»å– cookies")
        elif browser_name == 'brave':
            cookies = browser_cookie3.brave(domain_name='.youtube.com')
            print(f"âœ… å·²ä» Brave è¯»å– cookies")
        elif browser_name == 'opera':
            cookies = browser_cookie3.opera(domain_name='.youtube.com')
            print(f"âœ… å·²ä» Opera è¯»å– cookies")
        else:
            print(f"âŒ ä¸æ”¯æŒçš„æµè§ˆå™¨: {browser_name}")
            print("\næ”¯æŒçš„æµè§ˆå™¨:")
            print("  chrome, firefox, safari, edge, brave, opera")
            sys.exit(1)
    except Exception as e:
        print(f"âŒ è¯»å– cookies å¤±è´¥: {e}")
        print("\nå¯èƒ½çš„åŸå› :")
        print("  1. æµè§ˆå™¨æœªå®‰è£…")
        print("  2. æµè§ˆå™¨æ­£åœ¨è¿è¡Œï¼ˆè¯·å…ˆå…³é—­æµè§ˆå™¨ï¼‰")
        print("  3. æµè§ˆå™¨æ•°æ®è¢«å…¶ä»–ç¨‹åºé”å®š")
        sys.exit(1)

    if not cookies:
        print("âŒ æœªæ‰¾åˆ° YouTube cookies")
        print("\nè¯·ç¡®ä¿:")
        print("  1. ä½ å·²ç»åœ¨æµè§ˆå™¨ä¸­ç™»å½•äº† YouTube")
        print("  2. è®¿é—®è¿‡ https://www.youtube.com")
        sys.exit(1)

    return cookies


def export_cookies_netscape(cookies, output_file):
    """å¯¼å‡ºä¸º Netscape cookie æ ¼å¼ (yt-dlp æ ¼å¼)"""

    with open(output_file, 'w', encoding='utf-8') as f:
        # å†™å…¥æ–‡ä»¶å¤´
        f.write("# Netscape HTTP Cookie File\n")
        f.write("# This file is generated by Fish Music Cookie Exporter\n")
        f.write(f"# YouTube cookies for yt-dlp\n\n")

        count = 0
        for cookie in cookies:
            # åªå†™å…¥ YouTube ç›¸å…³çš„ cookies
            if 'youtube' in cookie.domain:
                # Netscape æ ¼å¼: domain \t flag \t path \t secure \t expiration \t name \t value
                line = (
                    f"{cookie.domain}\t"
                    f"{'TRUE' if cookie.domain.startswith('.') else 'FALSE'}\t"
                    f"{cookie.path or '/'}\t"
                    f"{'TRUE' if cookie.secure else 'FALSE'}\t"
                    f"{int(cookie.expires) if cookie.expires else 0}\t"
                    f"{cookie.name}\t"
                    f"{cookie.value or ''}\n"
                )
                f.write(line)
                count += 1

    print(f"âœ… å·²å¯¼å‡º {count} ä¸ª cookies åˆ° {output_file}")
    print(f"\nğŸ“ æ–‡ä»¶å¤§å°: {os.path.getsize(output_file)} å­—èŠ‚")

    return count


def main():
    print("=" * 60)
    print("ğŸª YouTube Cookies å¯¼å‡ºå·¥å…·")
    print("=" * 60)
    print()

    # æ£€æµ‹å‘½ä»¤è¡Œå‚æ•°
    if len(sys.argv) < 2:
        print("ç”¨æ³•: python export-cookies.py <æµè§ˆå™¨> [è¾“å‡ºæ–‡ä»¶]")
        print()
        print("æµè§ˆå™¨é€‰é¡¹:")
        print("  chrome  - Google Chrome (é»˜è®¤)")
        print("  firefox - Mozilla Firefox")
        print("  edge    - Microsoft Edge")
        print("  safari  - Safari (ä»… macOS)")
        print("  brave   - Brave Browser")
        print("  opera   - Opera")
        print()
        print("ç¤ºä¾‹:")
        print("  python export-cookies.py chrome")
        print("  python export-cookies.py firefox /path/to/youtube-cookies.txt")
        print()
        sys.exit(1)

    browser_name = sys.argv[1]

    # é»˜è®¤è¾“å‡ºæ–‡ä»¶å
    output_file = 'youtube-cookies.txt'
    if len(sys.argv) >= 3:
        output_file = sys.argv[2]

    print(f"ğŸ“‹ æ­¥éª¤ 1: ä» {browser_name} è¯»å– cookies")
    print()

    # è·å– cookies
    cookies = get_youtube_cookies(browser_name)

    print()
    print(f"ğŸ“‹ æ­¥éª¤ 2: å¯¼å‡ºä¸º Netscape æ ¼å¼")
    print()

    # å¯¼å‡º cookies
    count = export_cookies_netscape(cookies, output_file)

    print()
    print("=" * 60)
    print("âœ… å¯¼å‡ºå®Œæˆï¼")
    print("=" * 60)
    print()
    print("ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œ:")
    print(f"1. å°† {output_file} æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨")
    print("2. æ”¾åœ¨ä¸ docker-compose.yml ç›¸åŒçš„ç›®å½•")
    print("3. åœ¨ config.yaml ä¸­é…ç½®: cookies_file: \"/app/youtube-cookies.txt\"")
    print("4. é‡å¯æœåŠ¡: docker compose down && docker compose up -d")
    print()


if __name__ == '__main__':
    main()
